{% extends 'LaLune/base.html' %}
{% block body %}
<br><br>
<p class="subtitle fancy"><span><i><b>FINALIZACIJA NARUDŽBE</b></i></span></p><br>

    <table width="100%">
    <tr>
        <td valign="top">
            <div class="finalizacija" id="form-wrapper">
                <form id="form">
                    <div id="user-info">
                        <div class="form-field">
							<input  type="text" name="name" placeholder="Name..">
						</div>
						<div class="form-field">
							<input  type="email" name="email" placeholder="Email..">
						</div>
                        <br>

                    </div>
                    <div id="shipping-info">
                        <hr style="border: 1px solid #734f96;"><br>
						<p>Podaci za otpremnicu:</p><br>
						<div class="form-field">
							<input type="text" name="address" placeholder="Adresa..">
						</div>
						<div class="form-field">
							<input  type="text" name="city" placeholder="Grad..">
						</div>
                        <div class="form-field">
							<input  type="text" name="zipcode" placeholder="Poštanski broj..">
						</div>
                        <div class="form-field">
							<input  type="text" name="country" placeholder="Država..">
						</div>



                    </div>
                    <hr style="border: 1px solid #734f96;">
                    <input id="form-button" type="submit" class="btn" value="NASTAVI">
                </form>
            </div>
            <br>
            <div class="finalizacija hidden" style="text-align: center"  id="payment-info">
                <small>Da li želite finalizirati narudžbu?</small>
                <br>
                <button id="make-payment" class="btn">NARUČI</button>
            </div>
        </td>
        <td width="50%">
             <div class="finalizacija" style="width:500px;">
                 <a style="color:#734f96; text-decoration: none;"href="{% url 'korpa' %}">&#x2190; Moja Korpa</a>
                 <hr style="border: 1px solid #734f96;"><br>
				<h3>Sažetak narudžbe</h3>
				<hr style="border: 1px solid #734f96;">
                 {% for item in items %}
				<div class="cart-row">
					<div style="flex:2"><img class="row-image" src="{{ item.product.imageURL }}"></div>
					<div style="flex:2"><p>{{item.product.ime}}</p></div>
					<div style="flex:2"><p>{{ item.product.cijena|floatformat:2 }}KM</p></div>
					<div style="flex:1"><p>x{{ item.quantity }}</p></div>
				</div>
                 {% endfor %}

				<h5>Items:   {{ order.get_cart_items }}</h5>
				<h5>Total:   {{ order.get_cart_total|floatformat:2 }}KM</h5>
			</div>

        </td>
    </tr>
    </table>

    <script type="text/javascript">
    var shipping ='{{ order.shipping }}'
    var total ='{{ order.get_cart_total }}'

    if(shipping=='False'){
        document.getElementById('shipping-info').innerHTML=''
    }

    if(user != 'AnonymousUser'){
        document.getElementById('user-info').innerHTML=''
    }

    if(shipping=='False' && user!='AnonymousUser'){
        document.getElementById('form-wrapper').classList.add("hidden")
        document.getElementById('payment-info').classList.remove("hidden")
    }

    var form = document.getElementById('form')

    form.addEventListener('submit', function(e) {
        e.preventDefault()
        console.log('Form submitted')
        document.getElementById('form-button').classList.add('hidden')
        document.getElementById('payment-info').classList.remove('hidden')

    })

    document.getElementById('make-payment').addEventListener('click', function(e){
        submitFormData()
    })
    
    function submitFormData() {
        console.log('Payment button clicked')

        var userFormData = {
            'name':null,
            'email':null,
            'total':total,

        }

        var shippingInfo = {
            'address':null,
            'city':null,
            'zipcode':null,
            'country':null,

        }

        if(shipping != 'False'){
            shippingInfo.address = form.address.value
            shippingInfo.city = form.city.value
            shippingInfo.zipcode = form.zipcode.value
            shippingInfo.country = form.country.value
        }

        if(user == 'AnonymousUser'){
            userFormData.name = form.name.value
            userFormData.email = form.email.value

        }

        var url = 'process_order/'

        fetch(url,{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-CSRFToken':csrftoken,
            },
            body:JSON.stringify({'form':userFormData, 'shipping':shippingInfo})
        })
        .then((response)=> response.json())
        .then((data)=>{
            console.log('Success:',data);
            alert('Transakcija kompletirana');
            window.location.href = "{% url 'proizvodi' %}"
        })
    }
    </script>

{% endblock %}